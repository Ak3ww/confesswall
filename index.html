<script type="module">
  import { WebEthereum, WebUploader } from "https://esm.sh/@irys/web-upload@0.0.15";
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/+esm";

  let uploader;

  async function connectWallet() {
    try {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("wallet_addEthereumChain", [{
        chainId: "0x4f6",
        chainName: "Irys Testnet",
        nativeCurrency: { name: "IRYS", symbol: "IRYS", decimals: 18 },
        rpcUrls: ["https://testnet-rpc.irys.xyz/v1/execution-rpc"],
        blockExplorerUrls: ["https://testnet-explorer.irys.xyz"]
      }]);

      await provider.send("eth_requestAccounts", []);
      uploader = await WebUploader(WebEthereum).withProvider(provider);

      document.getElementById("connect").innerText = "Connected ✅";
      alert("Wallet connected to Irys Testnet!");
    } catch (err) {
      console.error("Connect error:", err);
      alert("⚠️ Wallet connection failed.");
    }
  }

  async function uploadMessage() {
    if (!uploader) return alert("⚠️ Connect your wallet first.");
    const msg = document.getElementById("message").value.trim();
    if (!msg) return alert("✏️ Write a message before uploading.");

    try {
      const res = await uploader.upload(msg);
      alert(`✅ Uploaded!\nhttps://gateway.irys.xyz/${res.id}`);
    } catch (err) {
      console.error("Upload error:", err);
      alert("❌ Upload failed. See console.");
    }
  }

  document.getElementById("connect").onclick = connectWallet;
  document.getElementById("upload").onclick = uploadMessage;
</script>
